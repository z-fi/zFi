<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>CHART</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 400' width='400' height='400'%3E%3Crect width='400' height='400' fill='%23000'/%3E%3CclipPath id='frame'%3E%3Crect width='400' height='400'/%3E%3C/clipPath%3E%3Cg clip-path='url(%23frame)'%3E%3Cpath d='M-60-20L460-20L460 90L80 310L460 310L460 420L-60 420L-60 310L320 90L-60 90Z' fill='white'/%3E%3C/g%3E%3C/svg%3E" type="image/svg+xml">
<script>
(function(){var d=localStorage.getItem('dark');if(d==='1'||(d===null&&matchMedia('(prefers-color-scheme:dark)').matches))document.documentElement.classList.add('dark')})();
</script>
<style>
:root {
  --bg:#fff;--fg:#000;--fg-muted:#666;--fg-dim:#999;
  --border:#000;--border-muted:#ddd;
  --surface:#f9f9f9;
  --btn-bg:#000;--btn-fg:#fff;--btn-hover:#333;
  --link-fg:inherit;
  --green:#22c55e;--red:#ef4444;
}
.dark {
  --bg:#0a0a0a;--fg:#e8e8e0;--fg-muted:#777;--fg-dim:#555;
  --border:#333;--border-muted:#333;
  --surface:#111;
  --btn-bg:#e8e8e0;--btn-fg:#0a0a0a;--btn-hover:#ccc;
  --link-fg:#e8e8e0;
  --green:#22c55e;--red:#ef4444;
}
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
  font-family: Helvetica, Arial, sans-serif;
  background: var(--bg);
  color: var(--fg);
  min-height: 100vh;
  padding: 60px 20px 20px;
  max-width: 960px;
  margin: 0 auto;
}
a { color: var(--link-fg); }
h1 {
  font-size: 14px;
  font-weight: 400;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  margin-bottom: 24px;
}
.pool-id {
  font-size: 11px;
  color: var(--fg-muted);
  margin-bottom: 16px;
  word-break: break-all;
  letter-spacing: 0.02em;
}
.chart-wrap {
  position: relative;
  width: 100%;
  height: min(56.25vw, 400px);
  background: var(--surface);
  border: 1px solid var(--border);
}
.chart-wrap iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border: none;
  background: var(--surface);
  color-scheme: light dark;
}
.chart-error {
  padding: 40px 20px;
  text-align: center;
  font-size: 13px;
  color: var(--fg-muted);
}
.chart-type-toggle {
  display:inline-flex;gap:0;margin-bottom:12px;border:1px solid var(--border);
}
.chart-type-toggle button {
  font-family:inherit;font-size:11px;font-weight:600;letter-spacing:0.05em;text-transform:uppercase;
  padding:6px 14px;border:none;cursor:pointer;background:transparent;color:var(--fg-muted);
}
.chart-type-toggle button.active { background:var(--btn-bg);color:var(--btn-fg); }
.chart-type-toggle button:not(.active):hover { color:var(--fg); }
.chart-tf-toggle { display:none;gap:0;margin-bottom:8px; }
.chart-tf-toggle.show { display:inline-flex; }
.chart-tf-toggle button {
  font-family:inherit;font-size:10px;font-weight:600;letter-spacing:0.05em;
  padding:4px 10px;border:none;cursor:pointer;background:transparent;color:var(--fg-dim);
}
.chart-tf-toggle button.active { color:var(--fg);text-decoration:underline;text-underline-offset:3px; }
.chart-tf-toggle button:not(.active):hover { color:var(--fg-muted); }
.dark-toggle {
  position: fixed;
  bottom: max(20px, env(safe-area-inset-bottom, 0px));
  right: max(20px, env(safe-area-inset-right, 0px));
  border: none; cursor: pointer; padding: 13px; margin: -13px;
  opacity: 0.5; transition: opacity 0.2s; z-index: 100;
  background: #000; border-radius: 50%; width: 40px; height: 40px; background-clip: content-box;
}
:root.dark .dark-toggle { background: #fff; }
.dark-toggle:hover { opacity: 1; }
.zorg-bg{fill:#fff}.zorg-fg{fill:#000}
.dark .zorg-bg{fill:#000}.dark .zorg-fg{fill:#fff}
.z-nav { position:fixed; top:max(16px, env(safe-area-inset-top)); left:max(16px, env(safe-area-inset-left)); z-index:200; }
.z-nav-btn { background:none; border:none; cursor:pointer; opacity:0.5; transition:opacity 0.2s; padding:6px; margin:-6px; line-height:0; }
.z-nav-btn:hover, .z-nav.open .z-nav-btn { opacity:1; }
.z-nav-menu { display:none; position:absolute; top:36px; left:0; background:var(--bg); border:1px solid var(--border); padding:8px 0; min-width:140px; max-height:calc(100vh - 60px); overflow-y:auto; }
.z-nav.open .z-nav-menu { display:block; }
.z-nav-menu a { display:block; padding:6px 16px; font-size:13px; color:var(--fg); text-decoration:none; letter-spacing:0.05em; }
.z-nav-menu a:hover { background:var(--surface); }
.z-nav-menu a.active { opacity:0.35; pointer-events:none; }
.z-nav-menu .z-nav-sep { border-top:1px solid var(--border); margin:6px 0; }
.activity-section {
  margin-top: 24px;
  border: 1px solid var(--border);
}
.activity-header {
  padding: 10px 12px;
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--fg-muted);
  border-bottom: 1px solid var(--border);
}
.activity-content { overflow-x:auto; }
.activity-table { width:100%;border-collapse:collapse;font-size:12px; }
.activity-table th {
  text-align:left;padding:6px 10px;font-size:10px;font-weight:600;letter-spacing:0.05em;
  text-transform:uppercase;color:var(--fg-muted);border-bottom:1px solid var(--border-muted);
}
.activity-table td { padding:5px 10px;border-bottom:1px solid var(--border-muted);white-space:nowrap; }
.activity-table tr:last-child td { border-bottom:none; }
.activity-table .evt-buy { color:var(--green); }
.activity-table .evt-sell { color:var(--red); }
.activity-table .evt-liqadd { color:var(--green); }
.activity-table .evt-liqrem { color:var(--red); }
.activity-table .evt-type { font-weight:600;font-size:11px; }
.activity-table a { color:var(--fg-muted);font-size:11px; }
.activity-table a:hover { color:var(--fg); }
.activity-more {
  display:block;width:100%;padding:8px;font-size:11px;font-weight:600;letter-spacing:0.05em;
  text-transform:uppercase;color:var(--fg-muted);background:transparent;border:none;border-top:1px solid var(--border-muted);
  cursor:pointer;font-family:inherit;
}
.activity-more:hover { color:var(--fg);background:var(--surface); }
.activity-empty { padding:16px;text-align:center;font-size:12px;color:var(--fg-muted); }
@media (max-width:600px) {
  body { padding:60px 12px 12px; }
  .dark-toggle { bottom:16px; right:16px; }
  .z-nav { top:14px; left:14px; }
  .z-nav-btn { padding:4px; margin:-4px; }
  .z-nav-menu a { padding:10px 16px; }
  h1 { font-size:13px; margin-bottom:16px; }
  .pool-id { font-size:10px; margin-bottom:12px; }
  .activity-table { font-size:11px;min-width:480px; }
  .activity-table th, .activity-table td { padding:4px 6px; }
}
@media (max-width:380px) {
  body { padding:60px 8px 8px; }
  h1 { font-size:12px; }
  .activity-table { font-size:10px;min-width:420px; }
  .activity-table th, .activity-table td { padding:3px 4px; }
  .activity-table a { font-size:10px; }
}
</style>
</head>
<body>

<div class="z-nav">
  <button class="z-nav-btn" onclick="this.parentElement.classList.toggle('open')" title="Menu">
    <svg width="28" height="28" viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg"><rect class="zorg-bg" width="400" height="400"/><clipPath id="zh"><rect width="400" height="400"/></clipPath><g clip-path="url(#zh)"><path class="zorg-fg" d="M-60-20L460-20L460 90L80 310L460 310L460 420L-60 420L-60 310L320 90L-60 90Z"/></g></svg>
  </button>
  <div class="z-nav-menu">
    <a href="../">Swap</a>
    <a href="../coin/">Coins</a>
    <a href="../predict/">Predict</a>
    <a id="navOrderbook" href="../orderbook/">Orderbook</a>
    <a href="../lp/">Liquidity</a>
    <a href="../domains/">Domains</a>
    <a href="../dao/">DAO</a>
    <div class="z-nav-sep"></div>
    <a href="../about/">About</a>
    <a href="https://github.com/z-fi/zFi" target="_blank" rel="noopener">GitHub</a>
  </div>
</div>

<button class="dark-toggle" onclick="toggleDark()" title="Toggle dark mode"></button>

<h1>Pool Chart</h1>
<div class="pool-id" id="poolIdDisplay"></div>
<div id="chartContainer"></div>
<div id="activitySection"></div>


<script>
document.addEventListener('click', e => { if (!e.target.closest('.z-nav')) document.querySelector('.z-nav')?.classList.remove('open'); });
function toggleDark() {
  document.documentElement.classList.toggle('dark');
  localStorage.setItem('dark', document.documentElement.classList.contains('dark') ? '1' : '0');
  updateIframeTheme();
}

function isDark() {
  return document.documentElement.classList.contains('dark');
}

function getPoolIdFromHash() {
  const hash = location.hash; // e.g. #/12345
  const m = hash.match(/^#\/(\d+)$/);
  return m ? m[1] : null;
}

var _chartType = 'line';
var _chartTf = '1h';

function chartEmbedUrl(poolId, type) {
  var theme = isDark() ? 'dark' : 'light';
  var url = 'https://www.zamm.finance/embed/pool/1/' + poolId + '?type=' + type + '&theme=' + theme;
  if (type === 'candle') url += '&tf=' + _chartTf;
  return url;
}

function updateIframeTheme() {
  var iframe = document.querySelector('.chart-wrap iframe');
  if (!iframe) return;
  try { iframe.contentWindow.postMessage({ type: 'theme', value: isDark() ? 'dark' : 'light' }, 'https://www.zamm.finance'); } catch(e) {}
}

function setChartType(type) {
  if (type === _chartType) return;
  _chartType = type;
  var poolId = getPoolIdFromHash();
  if (!poolId) return;
  var tfEl = document.getElementById('chartTfToggle');
  if (tfEl) tfEl.classList.toggle('show', type === 'candle');
  var wrap = document.querySelector('.chart-wrap');
  if (wrap) {
    var iframe = document.createElement('iframe');
    iframe.src = chartEmbedUrl(poolId, type);
    iframe.allow = 'clipboard-write';
    iframe.sandbox = 'allow-scripts allow-same-origin';
    wrap.replaceChildren(iframe);
  }
  var btns = document.querySelectorAll('.chart-type-toggle button');
  btns.forEach(function(b){ b.classList.toggle('active', b.dataset.type === type); });
}

function setChartTf(tf) {
  if (tf === _chartTf) return;
  _chartTf = tf;
  var poolId = getPoolIdFromHash();
  if (!poolId) return;
  var wrap = document.querySelector('.chart-wrap');
  if (wrap) {
    var iframe = document.createElement('iframe');
    iframe.src = chartEmbedUrl(poolId, 'candle');
    iframe.allow = 'clipboard-write';
    iframe.sandbox = 'allow-scripts allow-same-origin';
    wrap.replaceChildren(iframe);
  }
  var tfEl = document.getElementById('chartTfToggle');
  if (tfEl) tfEl.querySelectorAll('button').forEach(function(b){ b.classList.toggle('active', b.dataset.tf === tf); });
}

var _currentPoolId = null;
function render() {
  var poolId = getPoolIdFromHash();
  var container = document.getElementById('chartContainer');
  var poolIdDisplay = document.getElementById('poolIdDisplay');

  if (!poolId) {
    _currentPoolId = null;
    poolIdDisplay.textContent = '';
    container.replaceChildren();
    var err = document.createElement('div');
    err.className = 'chart-error';
    err.textContent = 'No pool ID provided. Use chart/#/{poolId}';
    container.appendChild(err);
    renderActivitySection(null);
    return;
  }

  if (poolId === _currentPoolId) return;
  _currentPoolId = poolId;

  var navOb = document.getElementById('navOrderbook');
  if (navOb) navOb.href = '../orderbook/#/' + poolId;

  poolIdDisplay.textContent = 'Pool ID: ' + poolId;
  container.replaceChildren();
  renderActivitySection(null);

  // Check for activity before showing chart
  fetch(INDEXER + '/api/events?poolId=' + poolId + '&limit=1')
    .then(function(r){ return r.json(); })
    .then(function(json){
      if (poolId !== _currentPoolId) return; // stale
      if (!json.data || !json.data.length) {
        var msg = document.createElement('div');
        msg.className = 'chart-error';
        msg.textContent = 'No trading activity for this pool';
        container.replaceChildren(msg);
        return;
      }
      var toggle = document.createElement('div');
      toggle.className = 'chart-type-toggle';
      var btnLine = document.createElement('button');
      btnLine.textContent = 'Line'; btnLine.dataset.type = 'line'; btnLine.className = 'active';
      btnLine.onclick = function(){ setChartType('line'); };
      var btnCandle = document.createElement('button');
      btnCandle.textContent = 'Candle'; btnCandle.dataset.type = 'candle';
      btnCandle.onclick = function(){ setChartType('candle'); };
      toggle.appendChild(btnLine); toggle.appendChild(btnCandle);

      var tfToggle = document.createElement('div');
      tfToggle.className = 'chart-tf-toggle' + (_chartType === 'candle' ? ' show' : '');
      tfToggle.id = 'chartTfToggle';
      ['1m','1h','1d'].forEach(function(tf){
        var btn = document.createElement('button');
        btn.textContent = tf; btn.dataset.tf = tf;
        if (tf === _chartTf) btn.className = 'active';
        btn.onclick = function(){ setChartTf(tf); };
        tfToggle.appendChild(btn);
      });

      var wrap = document.createElement('div');
      wrap.className = 'chart-wrap';
      var iframe = document.createElement('iframe');
      iframe.src = chartEmbedUrl(poolId, _chartType);
      iframe.allow = 'clipboard-write';
      iframe.sandbox = 'allow-scripts allow-same-origin';
      wrap.appendChild(iframe);

      container.replaceChildren(toggle, tfToggle, wrap);
      renderActivitySection(poolId);
    })
    .catch(function(){
      if (poolId !== _currentPoolId) return;
      var msg = document.createElement('div');
      msg.className = 'chart-error';
      msg.textContent = 'Failed to check pool activity';
      container.replaceChildren(msg);
    });
}

// ==================== POOL ACTIVITY ====================
var INDEXER = 'https://coinchan-indexer-production.up.railway.app';
var _activityCursor = null;
var _activityInterval = null;

var _escMap = {'&':'&amp;','<':'&lt;','>':'&gt;'};
function escText(s) { return String(s).replace(/[&<>]/g, function(m){ return _escMap[m]; }); }

function fmtWei(wei) {
  if (!wei || wei === '0') return '0';
  var s = wei.padStart(19, '0');
  var whole = s.slice(0, s.length - 18) || '0';
  var frac = s.slice(s.length - 18, s.length - 14);
  return whole + '.' + frac;
}

function fmtAge(ts) {
  var diff = Math.floor(Date.now() / 1000) - ts;
  if (diff < 60) return diff + 's ago';
  if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
  if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
  return Math.floor(diff / 86400) + 'd ago';
}

function activityRow(e) {
  var cls = 'evt-' + e.type.toLowerCase();
  var label = { BUY:'Buy', SELL:'Sell', LIQADD:'+LP', LIQREM:'-LP' }[e.type] || e.type;
  var ethAmt = (e.type === 'BUY' || e.type === 'LIQADD') ? fmtWei(e.amount0_in) : fmtWei(e.amount0_out);
  var tokenAmt = (e.type === 'BUY' || e.type === 'LIQREM') ? fmtWei(e.amount1_out) : fmtWei(e.amount1_in);
  var maker = e.maker ? e.maker.slice(0, 6) + '\u2026' + e.maker.slice(-4) : '-';
  var txShort = e.txhash.slice(0, 6) + '\u2026' + e.txhash.slice(-4);
  return '<tr class="' + cls + '">' +
    '<td>' + fmtAge(e.timestamp) + '</td>' +
    '<td class="evt-type">' + label + '</td>' +
    '<td>' + ethAmt + '</td>' +
    '<td>' + tokenAmt + '</td>' +
    '<td><a href="https://etherscan.io/address/' + escText(e.maker) + '" target="_blank">' + maker + '</a></td>' +
    '<td><a href="https://etherscan.io/tx/' + escText(e.txhash) + '" target="_blank">' + txShort + '</a></td>' +
  '</tr>';
}

function renderActivityTable(events, append) {
  var content = document.getElementById('activityContent');
  if (!content) return;
  if (!events.length && !append) {
    content.innerHTML = '<div class="activity-empty">No activity yet</div>';
    return;
  }
  var rows = events.map(activityRow).join('');
  if (append) {
    var tbody = content.querySelector('tbody');
    if (tbody) tbody.insertAdjacentHTML('beforeend', rows);
  } else {
    content.innerHTML = '<table class="activity-table">' +
      '<thead><tr><th>Age</th><th>Type</th><th>ETH</th><th>Token</th><th>Maker</th><th>Tx</th></tr></thead>' +
      '<tbody>' + rows + '</tbody></table>' +
      (_activityCursor ? '<button class="activity-more" onclick="loadMoreActivity()">Load More</button>' : '');
  }
}

function loadActivity(poolId) {
  fetch(INDEXER + '/api/events?poolId=' + poolId + '&limit=30')
    .then(function(r){ return r.json(); })
    .then(function(json){
      _activityCursor = json.nextCursor || null;
      renderActivityTable(json.data || [], false);
    })
    .catch(function(){
      var content = document.getElementById('activityContent');
      if (content) content.innerHTML = '<div class="activity-empty">Failed to load activity</div>';
    });
}

function refreshActivity(poolId) {
  fetch(INDEXER + '/api/events?poolId=' + poolId + '&limit=30')
    .then(function(r){ return r.json(); })
    .then(function(json){
      _activityCursor = json.nextCursor || null;
      renderActivityTable(json.data || [], false);
    })
    .catch(function(){});
}

function loadMoreActivity() {
  if (!_activityCursor) return;
  var poolId = getPoolIdFromHash();
  if (!poolId) return;
  var btn = document.querySelector('.activity-more');
  if (btn) { btn.textContent = 'Loading...'; btn.disabled = true; }
  fetch(INDEXER + '/api/events?poolId=' + poolId + '&limit=30&before=' + _activityCursor)
    .then(function(r){ return r.json(); })
    .then(function(json){
      _activityCursor = json.nextCursor || null;
      renderActivityTable(json.data || [], true);
      if (!_activityCursor && btn) btn.remove();
      else if (btn) { btn.textContent = 'Load More'; btn.disabled = false; }
    })
    .catch(function(){
      if (btn) { btn.textContent = 'Load More'; btn.disabled = false; }
    });
}

function renderActivitySection(poolId) {
  var section = document.getElementById('activitySection');
  if (!poolId) { section.innerHTML = ''; if (_activityInterval) { clearInterval(_activityInterval); _activityInterval = null; } return; }
  section.innerHTML = '<div class="activity-section">' +
    '<div class="activity-header">Pool Activity</div>' +
    '<div class="activity-content" id="activityContent"><div class="activity-empty">Loading\u2026</div></div>' +
    '</div>';
  loadActivity(poolId);
  if (_activityInterval) clearInterval(_activityInterval);
  _activityInterval = setInterval(function(){ refreshActivity(poolId); }, 30000);
}

render();
window.addEventListener('hashchange', render);
</script>
</body>
</html>
