<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>COLLECT</title>
<meta property="og:title" content="COLLECT">
<meta property="og:description" content="FundingWorks S02 Collector DAO">
<meta property="og:type" content="website">
<meta property="og:url" content="">
<meta property="og:image" content="">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="COLLECT">
<meta name="twitter:description" content="FundingWorks S02 Collector DAO">
<meta name="twitter:image" content="">
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 400' width='400' height='400'%3E%3Crect width='400' height='400' fill='%23000'/%3E%3CclipPath id='frame'%3E%3Crect width='400' height='400'/%3E%3C/clipPath%3E%3Cg clip-path='url(%23frame)'%3E%3Cpath d='M-60-20L460-20L460 90L80 310L460 310L460 420L-60 420L-60 310L320 90L-60 90Z' fill='white'/%3E%3C/g%3E%3C/svg%3E" type="image/svg+xml">
<link rel="stylesheet" href="../wallet.css">
<script>
(function(){var d=localStorage.getItem('dark');if(d==='1'||(d===null&&matchMedia('(prefers-color-scheme:dark)').matches))document.documentElement.classList.add('dark')})();
</script>
<style>
.zorg-bg{fill:#fff}.zorg-fg{fill:#000}
.dark .zorg-bg{fill:#000}.dark .zorg-fg{fill:#fff}
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
:root {
  --bg:#fff;--fg:#000;--fg-muted:#666;--fg-dim:#999;
  --border:#000;--border-muted:#ddd;
  --surface:#f9f9f9;--surface-hover:#f5f5f5;
  --btn-bg:#000;--btn-fg:#fff;--btn-hover:#333;
  --btn-dis-bg:transparent;--btn-dis-border:#ccc;--btn-dis-fg:#999;
  --status-error:#fff0f0;--status-success:#f0fff0;
  --link-fg:inherit;
  --modal-overlay:rgba(0,0,0,0.8);--modal-bg:#fff;--modal-border:#000;
  --green:#22c55e;
}
.dark {
  --bg:#0a0a0a;--fg:#e8e8e0;--fg-muted:#888;--fg-dim:#666;
  --border:#333;--border-muted:#333;
  --surface:#111;--surface-hover:#151515;
  --btn-bg:#e8e8e0;--btn-fg:#0a0a0a;--btn-hover:#ccc;
  --btn-dis-bg:transparent;--btn-dis-border:#444;--btn-dis-fg:#666;
  --status-error:#1a0000;--status-success:#001a00;
  --link-fg:#e8e8e0;
  --modal-overlay:rgba(0,0,0,0.85);--modal-bg:#111;--modal-border:#333;
  --green:#22c55e;
}
body {
  font-family:Helvetica,Arial,sans-serif;
  background:var(--bg);color:var(--fg);
  min-height:100vh;padding:60px 20px 20px;
  max-width:480px;margin:0 auto;
  overflow-x:hidden;
}
a { color:var(--link-fg); }
button {
  display:inline-block;font-family:inherit;cursor:pointer;
  border:1px solid var(--btn-bg);border-radius:0;
  background:var(--btn-bg);color:var(--btn-fg);
  padding:12px 24px;font-size:12px;font-weight:600;
  letter-spacing:0.1em;text-transform:uppercase;
  transition:background 0.2s, border-color 0.2s, color 0.2s;
}
button:hover { background:var(--btn-hover); }
button:disabled { background:var(--btn-dis-bg);border:1px solid var(--btn-dis-border);color:var(--btn-dis-fg);cursor:not-allowed; }
input, textarea {
  font-family:inherit;font-size:14px;background:transparent;color:var(--fg);
  border:none;border-bottom:1.5px solid var(--border);outline:none;
  padding:8px 0;width:100%;
}
textarea { resize:vertical;min-height:40px; }
.header {
  display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;
}
.header h1 {
  font-size:14px;font-weight:400;letter-spacing:0.1em;text-transform:uppercase;
}

/* Dark toggle */
.dark-toggle {
  position:fixed;bottom:max(20px, env(safe-area-inset-bottom, 0px));right:max(20px, env(safe-area-inset-right, 0px));
  border:none;cursor:pointer;padding:13px;margin:-13px;opacity:0.5;transition:opacity 0.2s;
  z-index:100;background:#000;border-radius:50%;width:40px;height:40px;background-clip:content-box;
}
:root.dark .dark-toggle { background:#fff; }
.dark-toggle:hover { opacity:1; }

.z-nav { position:fixed;top:max(16px, env(safe-area-inset-top));left:max(16px, env(safe-area-inset-left));z-index:200; }
.z-nav-btn { background:none;border:none;cursor:pointer;opacity:0.5;transition:opacity 0.2s;padding:6px;margin:-6px;line-height:0; }
.z-nav-btn:hover, .z-nav.open .z-nav-btn { opacity:1; }
.z-nav-menu { display:none;position:absolute;top:36px;left:0;background:var(--bg);border:1px solid var(--border);padding:8px 0;min-width:140px;max-height:calc(100vh - 60px);overflow-y:auto; }
.z-nav.open .z-nav-menu { display:block; }
.z-nav-menu a { display:block;padding:6px 16px;font-size:13px;color:var(--fg);text-decoration:none;letter-spacing:0.05em; }
.z-nav-menu a:hover { background:var(--surface); }
.z-nav-menu a.active { opacity:0.35;pointer-events:none; }
.z-nav-menu .z-nav-sep { border-top:1px solid var(--border);margin:6px 0; }

/* Modal */
.modal-overlay {
  display:none;position:fixed;inset:0;background:var(--modal-overlay);backdrop-filter:blur(4px);z-index:2000;
  justify-content:center;align-items:flex-start;padding:20px;padding-top:max(60px, env(safe-area-inset-top, 60px));
  overflow-y:auto;-webkit-overflow-scrolling:touch;
}
.modal-overlay.active { display:flex; }
body.modal-open { overflow:hidden; }
.modal {
  background:var(--modal-bg);border:1px solid var(--modal-border);
  width:100%;max-width:380px;padding:20px;position:relative;
  max-height:calc(100vh - 80px);max-height:calc(100dvh - 80px);
  display:flex;flex-direction:column;overflow-y:auto;-webkit-overflow-scrolling:touch;
}
.modal-header { display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-shrink:0; }
.modal-title { font-size:14px;font-weight:400;letter-spacing:0.1em;text-transform:uppercase; }
.modal-close {
  background:none;border:none;font-size:24px;color:var(--fg);cursor:pointer;line-height:1;
  padding:8px;margin:-8px;opacity:0.4;transition:opacity 0.15s;
}
.modal-close:hover { opacity:1; }

/* Form */
.form-section { margin-bottom:16px; }
.form-section label {
  display:block;font-size:10px;font-weight:600;letter-spacing:0.1em;
  text-transform:uppercase;color:var(--fg-dim);margin-bottom:4px;
}
.form-hint {
  font-size:12px;color:var(--fg-muted);margin-bottom:16px;line-height:1.5;
}

/* Status */
.status-message {
  font-size:12px;line-height:1.6;padding:12px;margin-bottom:16px;
  border:1px solid var(--border-muted);word-break:break-word;
}
.status-message.error { background:var(--status-error);border-color:#f00; }
.status-message.success { background:var(--status-success);border-color:#0a0; }
.status-message a { color:var(--link-fg);text-decoration:underline; }

/* Info */
.info-card {
  border:1px solid var(--border-muted);padding:14px;margin-bottom:16px;
}
.info-row { display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px; }
.info-label { color:var(--fg-dim); }
.info-value { font-weight:500;color:var(--fg-muted); }

/* Progress bar */
.sale-bar { height:6px;background:var(--border-muted);margin:8px 0; }
.sale-bar-fill { height:100%;background:var(--green);transition:width 0.3s; }

/* Action button */
.action-btn {
  width:100%;padding:14px 24px;font-size:13px;font-weight:600;
  letter-spacing:0.1em;text-transform:uppercase;margin-bottom:8px;
}

/* Mobile */
@media (max-width: 700px) {
  body { padding:80px 16px 20px; }
  .z-nav { top:14px;left:14px; }
  .z-nav-btn { padding:4px;margin:-4px; }
  .z-nav-menu a { padding:10px 16px; }
  input, textarea { font-size:16px; }
}
@media (max-width: 380px) {
  body { padding:70px 12px 20px; }
  input, textarea { font-size:16px; }
}
</style>
</head>
<body>
<div class="z-nav">
  <button class="z-nav-btn" onclick="this.parentElement.classList.toggle('open')" title="Menu">
    <svg width="28" height="28" viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg"><rect class="zorg-bg" width="400" height="400"/><clipPath id="zh"><rect width="400" height="400"/></clipPath><g clip-path="url(#zh)"><path class="zorg-fg" d="M-60-20L460-20L460 90L80 310L460 310L460 420L-60 420L-60 310L320 90L-60 90Z"/></g></svg>
  </button>
  <div class="z-nav-menu">
    <a href="../">Swap</a>
    <a href="../coin/">Coin</a>
    <a href="../predict/">Predict</a>
    <a href="../orderbook/">Orderbook</a>
    <a href="../lp/">Liquidity</a>
    <a href="../domains/">Domain</a>
    <a href="../dao/">DAO</a>
    <a href="./" class="active">Collect</a>
    <div class="z-nav-sep"></div>
    <a href="../about/">About</a>
    <a href="../api/">API</a>
    <a href="https://github.com/z-fi/zFi" target="_blank" rel="noopener">GitHub</a>
  </div>
</div>
<button class="dark-toggle" onclick="toggleDark()" title="Toggle dark mode"></button>

<div class="header">
  <h1>FW S02 Collector</h1>
</div>

<div class="form-hint">
  Collector DAO for <a href="https://etherscan.io/address/0xb33d806a94B6770C9d309E0842a75f8E6edCd5A6" target="_blank">FundingWorks S02</a>.
  Buy shares via <a href="../coin/#0xE7Aa6cA3a9Ca3fe92a425dFeaD24900B9BF49853" style="color:inherit;text-decoration:underline">coin page</a> &mdash; ETH goes to minter &mdash; mint open NFT slot when 1 ETH accumulates.
</div>

<!-- Dashboard (shown when DAO is deployed) -->
<div id="dashboard" style="display:none">
  <!-- Sale -->
  <div class="info-card" id="phase2Card">
    <div style="font-size:11px;letter-spacing:0.08em;text-transform:uppercase;color:var(--fg-dim);margin-bottom:8px">Sale</div>
    <div class="info-row"><span class="info-label">Status</span><span class="info-value" id="p2Status">loading...</span></div>
    <div class="sale-bar"><div class="sale-bar-fill" id="p2Bar" style="width:0%"></div></div>
    <div class="info-row"><span class="info-label">Shares remaining</span><span class="info-value" id="p2Remaining">-</span></div>
    <div class="info-row"><span class="info-label"><a id="minterLabel" href="#" target="_blank" style="color:inherit;text-decoration:none;border-bottom:1px dotted var(--fg-muted)">Minter</a> balance</span><span class="info-value" id="minterBalance">-</span></div>
    <div class="info-row"><span class="info-label">Next NFT progress</span><span class="info-value" id="p2NftPct">-</span></div>
  </div>

  <!-- NFT Progress -->
  <div class="info-card" id="nftCard"></div>

  <!-- Buy shares (via coin page) — pending governance -->
  <div id="buySection" style="font-size:12px;color:var(--fg-muted);text-align:center;padding:12px 0">Pending governance to continue sale</div>

  <!-- Mint from balance -->
  <button class="action-btn" id="mintBtn" onclick="mintFromBalance()" style="display:none">Mint NFT from Balance</button>

  <!-- Close sale -->
  <button class="action-btn" id="closeBtn" onclick="closeSale()" style="display:none">Close Sale &amp; Burn Unsold</button>

  <div id="statusArea"></div>

  <!-- User holdings -->
  <div class="info-card" id="userCard" style="display:none">
    <div class="info-row"><span class="info-label">Your shares</span><span class="info-value" id="userShares">-</span></div>
    <div class="info-row"><span class="info-label">Your % of supply</span><span class="info-value" id="userPct">-</span></div>
  </div>

  <!-- Phase 1 (collapsed) -->
  <details style="margin-top:12px;font-size:12px;color:var(--fg-muted)">
    <summary style="cursor:pointer;user-select:none">Initial Sale (Ended)</summary>
    <div class="info-card" style="margin-top:8px">
      <div class="info-row"><span class="info-label">Sale</span><span class="info-value" id="saleStatus">-</span></div>
      <div class="sale-bar"><div class="sale-bar-fill" id="saleBar" style="width:0%"></div></div>
      <div class="info-row"><span class="info-label">Shares sold</span><span class="info-value" id="sharesSold">-</span></div>
      <div class="info-row"><span class="info-label">ETH raised</span><span class="info-value" id="ethRaised">-</span></div>
      <div class="info-row" id="treasuryRow" style="display:none"><span class="info-label">DAO treasury</span><span class="info-value" id="treasury">-</span></div>
    </div>
  </details>

  <div style="font-size:11px;color:var(--fg-dim);margin-top:12px">
    <a href="" id="tradeLink" style="color:var(--fg-dim)">Trade</a>
    &middot; <a href="" id="daoLink" target="_blank" style="color:var(--fg-dim)">DAO</a>
    &middot; <a href="" id="minterLink" target="_blank" style="color:var(--fg-dim)">Minter</a>
    &middot; <a href="" id="manageLink" style="color:var(--fg-dim)">Manage DAO</a>
    &middot; <a href="https://etherscan.io/address/0x5D03BeE003859d250c1AB868490d09D90F10C8E8" target="_blank" style="color:var(--fg-dim)">Sale Contract</a>
  </div>
</div>

<!-- Deploy (shown when DAO not yet deployed) -->
<div id="deploySection">
  <div class="info-card" id="fwInfo">
    <div class="info-row"><span class="info-label">NFT mint price</span><span class="info-value">1 ETH</span></div>
    <div class="info-row"><span class="info-label">Sale target</span><span class="info-value">~1.11 ETH (1 ETH to mint + 10% LP)</span></div>
    <div class="info-row"><span class="info-label">Mint deadline</span><span class="info-value" id="fwDeadlineDeploy">loading...</span></div>
    <div class="info-row"><span class="info-label">Quorum</span><span class="info-value">15%</span></div>
    <div class="info-row"><span class="info-label">Voting / Timelock</span><span class="info-value">12h / 12h</span></div>
    <div class="info-row"><span class="info-label">LP seed</span><span class="info-value">10% of buys</span></div>
    <div class="info-row"><span class="info-label">Tap vesting</span><span class="info-value">Instant</span></div>
  </div>

  <div class="form-section">
    <label>DAO Name</label>
    <input type="text" id="daoName" placeholder="FW S02 Collectors" value="FW S02 Collectors" maxlength="50">
  </div>

  <div class="form-section">
    <label>DAO Symbol</label>
    <input type="text" id="daoSymbol" placeholder="FWC" value="FWC" maxlength="10">
  </div>

  <div class="form-section">
    <label>Description (optional)</label>
    <textarea id="daoDescription" placeholder="Collector DAO for FundingWorks Season 02 NFTs" rows="2"></textarea>
  </div>

  <div id="deployStatusArea"></div>

  <button class="action-btn" id="deployBtn" onclick="deploy()">Deploy Collector DAO</button>
</div>

<script src="../ethers.min.js"></script>
<script src="../walletconnect.min.js"></script>
<script src="../wallet.js"></script>
<script>
document.addEventListener('click', e => { if (!e.target.closest('.z-nav')) document.querySelector('.z-nav')?.classList.remove('open'); });
function toggleDark() {
  document.documentElement.classList.toggle('dark');
  localStorage.setItem('dark', document.documentElement.classList.contains('dark') ? '1' : '0');
}

// ==================== HELPERS ====================

const $ = id => document.getElementById(id);
const _escTextMap = { '&': '&amp;', '<': '&lt;', '>': '&gt;' };
function escText(s) { return String(s).replace(/[&<>]/g, m => _escTextMap[m]); }
function escAttr(s) { return escText(s).replace(/"/g, '&quot;').replace(/'/g, '&#39;'); }
function fmtETH(wei) { const e = Number(ethers.formatEther(wei)); return e < 0.001 && e > 0 ? '<0.001' : e.toFixed(e < 1 ? 4 : 3); }
function fmtShares(n) { const m = Number(n) / 1e18 / 1e6; return m >= 0.01 ? m.toFixed(2) + 'M' : (Number(n) / 1e18 / 1e3).toFixed(1) + 'K'; }

function showStatus(id, msg, isError) {
  const el = $(id);
  const cls = isError ? 'status-message error' : msg.includes('success') || msg.includes('Success') || msg.includes('Deployed') ? 'status-message success' : 'status-message';
  el.innerHTML = '<div class="' + cls + '">' + msg + '</div>';
}
function clearStatus(id) { $(id).innerHTML = ''; }

// ==================== CONFIG ====================

const RPCS = [
  'https://ethereum.publicnode.com',
  'https://1rpc.io/eth',
  'https://eth.drpc.org',
  'https://eth.llamarpc.com'
];
let rpcIdx = Math.floor(Math.random() * RPCS.length);
function getRPC() { return new ethers.JsonRpcProvider(RPCS[rpcIdx % RPCS.length], 1, { staticNetwork: true }); }

const PIN_URL = 'https://zfi-pin.rosscampbell9.workers.dev';

const FW_ADDRESS = '0xb33d806a94B6770C9d309E0842a75f8E6edCd5A6';
const FW_ABI = [
  'function MINT_PRICE() view returns (uint256)',
  'function MINT_PERIOD() view returns (uint256)',
  'function mintStartTime() view returns (uint256)'
];

// Predicted addresses (salt = keccak256("fw-s02-collect-v2"))
const DEPLOY_SALT = '0x23ebbfcfa85414d93a896eb8337b66966e6b20e71fca71338612630103124de1';
const DAO_ADDRESS = '0xE7Aa6cA3a9Ca3fe92a425dFeaD24900B9BF49853';
const SHARES_ADDRESS = '0x883d646d0C8202Aa23F01d4aF45E4E73804c3a49';

const DAICO_ADDR = '0x000000000033e92DB97B4B3beCD2c255126C60aC';
const VIEW_HELPER = '0x00000000006631040967E58e3430e4B77921a2db';

const MINTER_ABI = [
  'constructor(string,string,string,bytes32)',
  'function dao() view returns (address)',
  'function burner() view returns (address)',
  'function shares() view returns (address)',
  'function deadline() view returns (uint256)',
  'function mintFromTap(uint256) returns (uint256[])',
  'function mintFromBalance(uint256) returns (uint256[])',
  'function closeSale()',
  'function mintableFromTap() view returns (uint256)',
  'function mintableFromBalance() view returns (uint256)',
  'function allNftIds() view returns (uint256[])',
  'function nftCount() view returns (uint256)',
  'function totalLockedEth() view returns (uint256)'
];

const GET_DAICO_ABI = [
  'function getDAICO(address dao, address[] tribTokens) view returns (tuple(address dao, tuple(string name, string symbol, string contractURI, address sharesToken, address lootToken, address badgesToken, address renderer) meta, tuple(address tribTkn, uint256 tribAmt, uint256 forAmt, address forTkn, uint40 deadline, uint256 remainingSupply, uint256 totalSupply, uint256 treasuryBalance, uint256 allowance, uint16 lpBps, uint16 maxSlipBps, uint256 feeOrHook)[] sales, tuple(address ops, address tribTkn, uint128 ratePerSec, uint64 lastClaim, uint256 claimable, uint256 pending, uint256 treasuryBalance, uint256 tapAllowance) tap))'
];

const DAICO_BUY_ABI = [
  'function buy(address dao, address tribTkn, uint256 payAmt, uint256 minBuyAmt) payable'
];

const SHARES_ABI = [
  'function balanceOf(address) view returns (uint256)',
  'function totalSupply() view returns (uint256)'
];

const FOLLOW_ON_SALE = '0x5D03BeE003859d250c1AB868490d09D90F10C8E8';
const P2_CAP = 9_000_000n * 10n**18n; // 9M shares
const MOLOCH_ABI = ['function allowance(address token, address spender) view returns (uint256)'];
const FOLLOW_ON_ABI = ['function paused() view returns (bool)'];

let _minterAddress = null; // discovered from tap.ops

// ==================== DASHBOARD ====================

let _daoDeployed = false;

async function loadDashboard() {
  try {
    const rpc = getRPC();
    const helper = new ethers.Contract(VIEW_HELPER, GET_DAICO_ABI, rpc);
    const data = await helper.getDAICO(DAO_ADDRESS, [ethers.ZeroAddress]);

    _minterAddress = data.tap.ops;
    const sale = data.sales[0];
    const sold = sale.totalSupply - sale.remainingSupply;
    const totalSale = sale.totalSupply;
    const salePct = Number(sold) / Number(totalSale) * 100;
    const p1deadline = Number(sale.deadline);
    const now = Date.now() / 1000;
    const p1Active = now < p1deadline && sale.remainingSupply > 0n;

    // Phase 1 (collapsed)
    if (p1Active) {
      $('saleStatus').innerHTML = '<span style="color:var(--green)">Live</span>';
    } else if (sale.remainingSupply === 0n) {
      $('saleStatus').textContent = 'Sold Out';
    } else {
      $('saleStatus').textContent = 'Ended';
    }
    $('saleBar').style.width = Math.min(salePct, 100).toFixed(1) + '%';
    $('sharesSold').textContent = fmtShares(sold) + ' / ' + fmtShares(totalSale);
    const ethRaisedWei = sale.forAmt > 0n ? sold * sale.tribAmt / sale.forAmt : 0n;
    $('ethRaised').textContent = fmtETH(ethRaisedWei) + ' ETH';
    if (data.tap.treasuryBalance > 0n) {
      $('treasuryRow').style.display = '';
      $('treasury').textContent = fmtETH(data.tap.treasuryBalance) + ' ETH';
    }

    // Phase 2 sale data
    const moloch = new ethers.Contract(DAO_ADDRESS, MOLOCH_ABI, rpc);
    const followOn = new ethers.Contract(FOLLOW_ON_SALE, FOLLOW_ON_ABI, rpc);
    const [p2Allowance, p2Paused] = await Promise.all([
      moloch.allowance(DAO_ADDRESS, FOLLOW_ON_SALE),
      followOn.paused()
    ]);
    const p2Remaining = p2Allowance;
    const p2Sold = P2_CAP - p2Remaining;
    const p2Pct = Number(p2Sold * 10000n / P2_CAP) / 100;

    if (p2Paused) {
      $('p2Status').innerHTML = '<span style="color:var(--fg-muted)">Paused</span>';
    } else if (p2Remaining === 0n) {
      $('p2Status').textContent = 'Sold Out';
    } else {
      $('p2Status').innerHTML = '<span style="color:var(--green)">Open</span>';
    }
    $('p2Bar').style.width = Math.min(p2Pct, 100).toFixed(2) + '%';
    $('p2Remaining').textContent = fmtShares(p2Remaining) + ' / ' + fmtShares(P2_CAP);


    // Minter data
    if (_minterAddress && _minterAddress !== ethers.ZeroAddress) {
      const minter = new ethers.Contract(_minterAddress, MINTER_ABI, rpc);
      const [nftCount, lockedEth, mintableFromBal, mintableFromTapN, minterBal] = await Promise.all([
        minter.nftCount(),
        minter.totalLockedEth(),
        minter.mintableFromBalance(),
        minter.mintableFromTap(),
        rpc.getBalance(_minterAddress)
      ]);
      const mintable = mintableFromBal > mintableFromTapN ? mintableFromBal : mintableFromTapN;
      const useMintFromBalance = mintableFromBal > 0n;
      $('minterBalance').textContent = fmtETH(minterBal) + ' ETH';
      const nftPct = Math.min(Number(minterBal * 10000n / ethers.parseEther('1')) / 100, 100);
      $('p2NftPct').innerHTML = `<span style="color:var(--green);font-weight:600">${nftPct.toFixed(1)}%</span>`;
      $('minterLabel').href = 'https://etherscan.io/address/' + _minterAddress;
      const nftCard = $('nftCard');
      const nc = Number(nftCount);
      const mt = Number(mintable);
      // Progress = minter balance (ETH leaves minter when spent on FW mint)
      const progressWei = minterBal;
      const MINT_PRICE = ethers.parseEther('1');
      if (nc > 0) {
        const nextN = nc + 1;
        const pct = Math.min(Number(progressWei * 10000n / MINT_PRICE) / 100, 100);
        nftCard.innerHTML = `
          <div class="info-row"><span class="info-label">NFTs in <a href="https://opensea.io/0xb3b3f4f1535305c5f40f9c0d6bcaf38032bf7f8e" target="_blank" style="color:inherit;text-decoration:underline">vault</a></span><span class="info-value">${nc}</span></div>
          <div class="info-row"><span class="info-label">Locked ETH</span><span class="info-value">${fmtETH(lockedEth)} ETH</span></div>
          ${mt > 0 ? `<div class="info-row"><span class="info-label">Mintable NFTs</span><span class="info-value" style="color:var(--green)">${mt}</span></div>` : ''}
          <div class="info-row" style="margin-top:8px"><span class="info-label">Progress to NFT #${nextN}</span><span class="info-value">${fmtETH(progressWei)} / 1.0 ETH</span></div>
          <div class="sale-bar"><div class="sale-bar-fill" style="width:${pct.toFixed(1)}%"></div></div>
        `;
      } else if (mt > 0) {
        nftCard.innerHTML = `
          <div class="info-row"><span class="info-label">Ready to mint</span><span class="info-value" style="color:var(--green)">${mt} NFT${mt > 1 ? 's' : ''}</span></div>
        `;
      } else {
        // Show progress toward next NFT
        const nextN = nc + 1;
        const pct = Math.min(Number(progressWei * 10000n / MINT_PRICE) / 100, 100);
        nftCard.innerHTML = `
          <div class="info-row"><span class="info-label">Progress to NFT #${nextN}</span><span class="info-value" style="color:var(--green)">${fmtETH(progressWei)} / 1.0 ETH</span></div>
          <div class="sale-bar"><div class="sale-bar-fill" style="width:${pct.toFixed(1)}%"></div></div>
          <div style="font-size:11px;color:var(--fg-dim);margin-top:4px">${fmtETH(minterBal)} ETH in <a href="https://etherscan.io/address/${_minterAddress}" target="_blank" style="color:inherit;text-decoration:underline">minter</a> &mdash; each 1 ETH mints a FW S02 NFT</div>
        `;
      }

      if (mt > 0) {
        $('mintBtn').style.display = '';
        $('mintBtn').textContent = `Mint ${mt} NFT${mt > 1 ? 's' : ''}`;
        $('mintBtn').dataset.useBalance = useMintFromBalance ? '1' : '';
      } else {
        $('mintBtn').style.display = 'none';
      }

      // Close sale button
      if (now > p1deadline && sale.remainingSupply > 0n) {
        // Check if DAO still holds shares (not yet closed)
        const shares = new ethers.Contract(SHARES_ADDRESS, SHARES_ABI, rpc);
        const daoBal = await shares.balanceOf(DAO_ADDRESS);
        if (daoBal > 0n) {
          $('closeBtn').style.display = '';
        }
      }

      // Links
      $('tradeLink').href = '../coin/#' + DAO_ADDRESS;
      $('daoLink').href = 'https://etherscan.io/address/' + DAO_ADDRESS;
      $('minterLink').href = 'https://etherscan.io/address/' + _minterAddress;
      $('manageLink').href = '../dao/#/dao/1/' + DAO_ADDRESS;
    }

    // Buy section — always show (Phase 2 link to coin page)

    // User balance
    if (_connectedAddress) {
      const shares = new ethers.Contract(SHARES_ADDRESS, SHARES_ABI, rpc);
      const [userBal, totalSupply] = await Promise.all([
        shares.balanceOf(_connectedAddress),
        shares.totalSupply()
      ]);
      if (userBal > 0n) {
        $('userCard').style.display = '';
        $('userShares').textContent = fmtShares(userBal);
        const pct = totalSupply > 0n ? (Number(userBal) / Number(totalSupply) * 100).toFixed(2) : '0';
        $('userPct').textContent = pct + '%';
      }
    }
  } catch (e) {
    console.error('Dashboard load failed:', e);
  }
}

// ==================== ACTIONS ====================

async function mintFromBalance() {
  if (!_signer) { toggleWallet(); return; }
  if (!_minterAddress) return;
  $('mintBtn').disabled = true;
  try {
    showStatus('statusArea', 'Confirm in wallet...');
    const minter = new ethers.Contract(_minterAddress, MINTER_ABI, _signer);
    const useBalance = $('mintBtn').dataset.useBalance === '1';
    const tx = useBalance ? await minter.mintFromBalance(1) : await minter.mintFromTap(0);
    showStatus('statusArea', `Tx submitted. <a href="https://etherscan.io/tx/${tx.hash}" target="_blank">${tx.hash.slice(0,10)}...</a>`);
    await tx.wait();
    showStatus('statusArea', `NFT minted! <a href="https://etherscan.io/tx/${tx.hash}" target="_blank">View tx</a>`);
    loadDashboard();
  } catch (e) {
    if ((e.message || '').toLowerCase().includes('user rejected') || e.code === 'ACTION_REJECTED') {
      clearStatus('statusArea');
    } else {
      showStatus('statusArea', escText((e.shortMessage || e.reason || e.message || '').split('\n')[0].slice(0, 120)), true);
    }
  } finally { $('mintBtn').disabled = false; }
}

async function closeSale() {
  if (!_signer) { toggleWallet(); return; }
  if (!_minterAddress) return;
  $('closeBtn').disabled = true;
  try {
    showStatus('statusArea', 'Confirm in wallet...');
    const minter = new ethers.Contract(_minterAddress, MINTER_ABI, _signer);
    const tx = await minter.closeSale();
    showStatus('statusArea', `Tx submitted. <a href="https://etherscan.io/tx/${tx.hash}" target="_blank">${tx.hash.slice(0,10)}...</a>`);
    await tx.wait();
    showStatus('statusArea', `Sale closed, unsold shares burned! <a href="https://etherscan.io/tx/${tx.hash}" target="_blank">View tx</a>`);
    $('closeBtn').style.display = 'none';
    loadDashboard();
  } catch (e) {
    if ((e.message || '').toLowerCase().includes('user rejected') || e.code === 'ACTION_REJECTED') {
      clearStatus('statusArea');
    } else {
      showStatus('statusArea', escText((e.shortMessage || e.reason || e.message || '').split('\n')[0].slice(0, 120)), true);
    }
  } finally { $('closeBtn').disabled = false; }
}

// ==================== DEPLOY ====================

let _deploying = false;
let MINTER_BYTECODE = null;

async function loadBytecode() {
  if (MINTER_BYTECODE) return MINTER_BYTECODE;
  try {
    const res = await fetch('./FundingWorksMinter.json');
    if (res.ok) {
      const artifact = await res.json();
      MINTER_BYTECODE = artifact.bytecode?.object || artifact.bytecode;
      if (MINTER_BYTECODE && !MINTER_BYTECODE.startsWith('0x')) MINTER_BYTECODE = '0x' + MINTER_BYTECODE;
      return MINTER_BYTECODE;
    }
  } catch (e) {}
  throw new Error('Contract bytecode not found. Place FundingWorksMinter.json in the collect/ directory.');
}

async function deploy() {
  if (_deploying) return;
  if (!_signer) { toggleWallet(); return; }

  const name = $('daoName').value.trim();
  const symbol = $('daoSymbol').value.trim();
  const desc = $('daoDescription').value.trim();

  if (!name || name.length < 2) { showStatus('deployStatusArea', 'Enter a DAO name (at least 2 characters)', true); return; }
  if (!symbol || symbol.length < 1) { showStatus('deployStatusArea', 'Enter a DAO symbol', true); return; }

  _deploying = true;
  $('deployBtn').disabled = true;

  try {
    showStatus('deployStatusArea', 'Loading contract bytecode...');
    const bytecode = await loadBytecode();

    const metadata = { name, symbol };
    if (desc) metadata.description = desc;
    metadata.type = 'fw-collector';

    showStatus('deployStatusArea', 'Pinning metadata to IPFS...');
    const orgURI = await pinMetadata(metadata);

    showStatus('deployStatusArea', 'Please confirm the transaction in your wallet...');
    const factory = new ethers.ContractFactory(MINTER_ABI, bytecode, _signer);
    const tx = await factory.deploy(name, symbol, orgURI, DEPLOY_SALT);

    const minterAddress = await tx.getAddress();
    showStatus('deployStatusArea',
      `Transaction submitted. <a href="https://etherscan.io/tx/${tx.deploymentTransaction().hash}" target="_blank">${tx.deploymentTransaction().hash.slice(0,10)}...</a> Waiting for confirmation...`
    );

    await tx.waitForDeployment();

    showStatus('deployStatusArea',
      `<strong>Deployed!</strong><br>` +
      `Minter: <a href="https://etherscan.io/address/${minterAddress}" target="_blank">${minterAddress}</a><br>` +
      `DAO: <a href="https://etherscan.io/address/${DAO_ADDRESS}" target="_blank">${DAO_ADDRESS}</a>`
    );

    // Switch to dashboard
    setTimeout(() => {
      $('deploySection').style.display = 'none';
      $('dashboard').style.display = '';
      _daoDeployed = true;
      loadDashboard();
    }, 2000);
  } catch (e) {
    if ((e.message || '').toLowerCase().includes('user rejected') || e.code === 'ACTION_REJECTED') {
      showStatus('deployStatusArea', 'Deploy cancelled', false);
    } else {
      const msg = e.shortMessage || e.reason || (e.message || '').split('\n')[0];
      showStatus('deployStatusArea', escText(msg.length < 120 ? msg : 'Deploy failed'), true);
      console.error('Deploy error:', e);
    }
  } finally {
    _deploying = false;
    $('deployBtn').disabled = false;
  }
}

async function pinMetadata(metadata) {
  if (!PIN_URL) return 'data:application/json;utf8,' + JSON.stringify(metadata);
  const res = await fetch(PIN_URL + '/pin-json', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(metadata),
  });
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || 'Metadata pin failed');
  return 'ipfs://' + data.cid;
}

// ==================== FW INFO (for deploy section) ====================

async function loadFWInfo() {
  try {
    const rpc = getRPC();
    const fw = new ethers.Contract(FW_ADDRESS, FW_ABI, rpc);
    const [mintStart, mintPeriod] = await Promise.all([
      fw.mintStartTime(),
      fw.MINT_PERIOD()
    ]);
    const deadline = Number(mintStart) + Number(mintPeriod);
    const d = new Date(deadline * 1000);
    const now = Date.now() / 1000;
    const remaining = deadline - now;
    let text = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    if (remaining <= 0) text += ' (ended)';
    else if (remaining < 86400) text += ' (' + Math.floor(remaining / 3600) + 'h left)';
    else text += ' (' + Math.floor(remaining / 86400) + 'd left)';
    $('fwDeadlineDeploy').textContent = text;
  } catch (e) {
    $('fwDeadlineDeploy').textContent = 'error';
  }
}

// ==================== INIT ====================

async function init() {
  const rpc = getRPC();
  // Check if DAO is deployed
  const code = await rpc.getCode(DAO_ADDRESS);
  if (code && code !== '0x') {
    _daoDeployed = true;
    $('deploySection').style.display = 'none';
    $('dashboard').style.display = '';
    loadDashboard();
  } else {
    loadFWInfo();
  }
}

init();
walletInit({ appName: 'zFi Collect', onConnect: [() => { if (_daoDeployed) loadDashboard(); }], onDisconnect: [() => { $('userCard').style.display = 'none'; }] });
</script>
</body>
</html>
